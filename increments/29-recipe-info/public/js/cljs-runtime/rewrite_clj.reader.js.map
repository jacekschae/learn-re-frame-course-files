{"version":3,"sources":["rewrite_clj/reader.cljs"],"sourcesContent":["(ns rewrite-clj.reader\n  (:refer-clojure :exclude [peek next])\n  (:require [cljs.tools.reader :as r]\n            [cljs.tools.reader.reader-types :as reader-types]\n            [cljs.tools.reader.impl.commons :refer [parse-symbol]]\n            [goog.string :as gstring]\n            [rewrite-clj.node.protocols :as nd]))\n\n(def read-char reader-types/read-char)\n(def get-column-number reader-types/get-column-number)\n(def get-line-number reader-types/get-line-number)\n(def peek-char reader-types/peek-char)\n(def indexing-push-back-reader reader-types/indexing-push-back-reader)\n(def unread reader-types/unread)\n(def read-string r/read-string)\n\n;; TODO: try to get goog.string.format up and running !\n(defn throw-reader\n  \"Throw reader exception, including line/column.\"\n  [^not-native reader fmt & data]\n  (let [c (get-column-number reader)\n        l (get-line-number reader)]\n    (throw\n      (js/Error.\n        (str data fmt\n             \" [at line \" l \", column \" c \"]\")))))\n\n\n(defn boundary?\n  \"Check whether a given char is a token boundary.\"\n  [c]\n  (< -1 (.indexOf #js [\\\" \\: \\; \\' \\@ \\^ \\` \\~\n                       \\( \\) \\[ \\] \\{ \\} \\\\ nil] c)))\n\n(defn- ^boolean whitespace?\n  \"Checks whether a given character is whitespace\"\n  [ch]\n  ;(or (gstring/isBreakingWhitespace ch) (identical? \\, ch))\n  (< -1 (.indexOf #js [\\return \\newline \\tab \\space \",\"] ch)))\n\n(defn ^boolean linebreak?\n  \"Checks whether the character is a newline\"\n  [c]\n  (< -1 (.indexOf #js [\\return \\newline] c)))\n\n(defn ^boolean space?\n  \"Checks whether the character is a space\"\n  [c]\n  (< -1 (.indexOf #js [\\tab \\space \",\"] c)))\n\n(defn ^boolean whitespace-or-boundary?\n  [c]\n  (or (whitespace? c) (boundary? c)))\n\n(def buf (gstring/StringBuffer. \"\"))\n\n(defn read-while\n  \"Read while the chars fulfill the given condition. Ignores\n  the unmatching char.\"\n  ([^not-native reader p?]\n   (read-while reader p? (not (p? nil))))\n\n  ([^not-native reader p? eof?]\n    (.clear buf)\n    (loop []\n      (if-let [c (read-char reader)]\n        (if (p? c)\n          (do\n            (.append buf c)\n            (recur))\n          (do\n            (unread reader c)\n            (.toString buf)))\n        (if eof?\n          (.toString buf)\n          (throw-reader reader \"Unexpected EOF.\"))))))\n\n(defn read-until\n  \"Read until a char fulfills the given condition. Ignores the\n   matching char.\"\n  [^not-native reader p?]\n  (read-while\n    reader\n    (complement p?)\n    (p? nil)))\n\n(defn read-include-linebreak\n  \"Read until linebreak and include it.\"\n  [^not-native reader]\n  (str\n    (read-until\n      reader\n      #(or (nil? %) (linebreak? %)))\n    (read-char reader)))\n\n(defn string->edn\n  \"Convert string to EDN value.\"\n  [s]\n  (read-string s))\n\n(defn ignore\n  \"Ignore the next character.\"\n  [^not-native reader]\n  (read-char reader)\n  nil)\n\n\n(defn next\n  \"Read next char.\"\n  [^not-native reader]\n  (read-char reader))\n\n(defn peek\n  \"Peek next char.\"\n  [^not-native reader]\n  (peek-char reader))\n\n\n\n(defn read-with-meta\n  \"Use the given function to read value, then attach row/col metadata.\"\n  [^not-native reader read-fn]\n  (let [row (get-line-number reader)\n        col (get-column-number reader)\n        ^not-native entry (read-fn reader)]\n    (when entry\n      (let [end-row (get-line-number reader)\n            end-col (get-column-number reader)\n            end-col (if (= 0 end-col)\n                      (+ col (.-length (nd/string entry)))\n                      end-col)] ; TODO: Figure out why numbers are sometimes whacky\n        (if (= 0 col) ; why oh why\n          entry\n          (-with-meta\n            entry\n            {:row row\n             :col col\n             :end-row end-row\n             :end-col end-col}))))))\n\n(defn read-repeatedly\n  \"Call the given function on the given reader until it returns\n   a non-truthy value.\"\n  [^not-native reader read-fn]\n  (->> (repeatedly #(read-fn reader))\n       (take-while identity)\n       (doall)))\n\n\n(defn read-n\n  \"Call the given function on the given reader until `n` values matching `p?` have been\n   collected.\"\n  [^not-native reader node-tag read-fn p? n]\n  {:pre [(pos? n)]}\n  (loop [c 0\n         vs []]\n    (if (< c n)\n      (if-let [v (read-fn reader)]\n        (recur\n          (if (p? v) (inc c) c)\n          (conj vs v))\n        (throw-reader\n          reader\n          \"%s node expects %d value%s.\"\n          node-tag\n          n\n          (if (= n 1) \"\" \"s\")))\n      vs)))\n\n(defn- re-matches*\n  [re s]\n  (let [matches (.exec re s)]\n    (when (and (not (nil? matches))\n               (identical? (aget matches 0) s))\n      (if (== (alength matches) 1)\n        (aget matches 0)\n        matches))))\n\n(defn read-keyword\n  [^not-native reader initch]\n  (let [tok (cljs.tools.reader/read-token reader :keyword (read-char reader))\n        a (re-matches* (re-pattern \"^[:]?([^0-9/].*/)?([^0-9/][^/]*)$\") tok)\n        token (aget a 0)\n        ns (aget a 1)\n        name (aget a 2)]\n    (if (or (and (not (undefined? ns))\n                 (identical? (. ns (substring (- (.-length ns) 2) (.-length ns))) \":/\"))\n            (identical? (aget name (dec (.-length name))) \":\")\n            (not (== (.indexOf token \"::\" 1) -1)))\n      (cljs.tools.reader.impl.errors/reader-error reader \n                                                  \"Invalid token: \" \n\t\t\t\t\t\t  token)\n      (if (and (not (nil? ns)) (> (.-length ns) 0))\n        (keyword (.substring ns 0 (.indexOf ns \"/\")) name)\n        (keyword (.substring token 1))))))\n\n;; (let [form-rdr (r/indexing-push-back-reader \"(+ 1 1)\")]\n;;   (read-include-linebreak form-rdr))\n\n\n;(re-matches* (re-pattern \"^[:]?([^0-9/].*/)?([^0-9/][^/]*)$\") \":%dill.*\")\n"],"mappings":"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","names":["rewrite-clj.reader/read-char","cljs.tools.reader.reader-types/read-char","rewrite-clj.reader/get-column-number","cljs.tools.reader.reader-types/get-column-number","rewrite-clj.reader/get-line-number","cljs.tools.reader.reader-types/get-line-number","rewrite-clj.reader/peek-char","cljs.tools.reader.reader-types/peek-char","rewrite-clj.reader/indexing-push-back-reader","cljs.tools.reader.reader-types/indexing-push-back-reader","rewrite-clj.reader/unread","cljs.tools.reader.reader-types/unread","rewrite-clj.reader/read-string","cljs.tools.reader/read-string","var_args","args__4736__auto__","len__4730__auto__","i__4731__auto__","argseq__4737__auto__","cljs.core/IndexedSeq","rewrite-clj.reader/throw-reader","seq30366","G__30367","cljs.core/first","cljs.core/next","G__30368","self__4717__auto__","reader","fmt","data","c","l","js/Error","rewrite-clj.reader/boundary?","rewrite-clj.reader/whitespace?","ch","rewrite-clj.reader/linebreak?","rewrite-clj.reader/space?","rewrite-clj.reader/whitespace-or-boundary?","rewrite-clj.reader/buf","goog.string/StringBuffer","G__30370","rewrite-clj.reader/read-while","p?","rewrite_clj.reader.read_while.cljs$core$IFn$_invoke$arity$3","cljs.core/not","eof?","temp__5455__auto__","rewrite-clj.reader/read-until","cljs.core/complement","rewrite-clj.reader/read-include-linebreak","p1__30371#","rewrite-clj.reader/string->edn","s","rewrite-clj.reader/ignore","rewrite-clj.reader/next","rewrite-clj.reader/peek","rewrite-clj.reader/read-with-meta","read-fn","row","col","entry","end-row","end-col","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","rewrite-clj.reader/read-repeatedly","cljs.core.repeatedly.cljs$core$IFn$_invoke$arity$1","cljs.core.take_while.cljs$core$IFn$_invoke$arity$2","cljs.core/identity","cljs.core.doall.cljs$core$IFn$_invoke$arity$1","rewrite-clj.reader/read-n","node-tag","n","vs","v","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","rewrite_clj.reader.throw_reader.cljs$core$IFn$_invoke$arity$variadic","rewrite-clj.reader/re-matches*","re","matches","rewrite-clj.reader/read-keyword","initch","tok","cljs.tools.reader/read-token","a","cljs.core/re-pattern","token","ns","name","cljs.tools.reader.impl.errors.reader_error.cljs$core$IFn$_invoke$arity$variadic","cljs.core.keyword.cljs$core$IFn$_invoke$arity$2","cljs.core.keyword.cljs$core$IFn$_invoke$arity$1"]}